{% extends "varasto/base_main.html" %}

{% load static %}

{% block stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'varasto/new_event.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'varasto/base_main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'varasto/new_event_goods.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
{% endblock %}

{% block title %}Uusi tapahtuma{% endblock %}
{% block path %}Uusi tapahtuma{% endblock %}
{% block page %}Uusi tapahtuma{% endblock %}

{% block script %}
<script type="text/javascript">
$(document).ready(function() {
    // Barcode reader
    var barcode = ''
    var interval
    document.addEventListener('keydown', function(e) {
        if (interval){
            clearInterval(interval)
        }
        if (e.keyCode == 13){
            if (barcode) {
                printBarcode(barcode)
                checkBarcode(barcode)
            }
            barcode = ''
            document.querySelector("button[name=_add_user]").click()
            return
        }
        if (e.key != 'Shift')
            barcode += e.key // Tarkista, että barcode on ainakin 3 kirjainta (Letter, num, chr13)
        interval = setInterval(() => barcode = '', 20) // interval min 20ms
    })
    function checkBarcode(scanned_barcode){
        if (parseInt(scanned_barcode, 10))
            document.querySelector('#add_user').value = scanned_barcode
        else if (scanned_barcode[0]=='A')
            document.querySelector('#add_item').value = scanned_barcode.slice(1)
    }
    function printBarcode(scanned_barcode){
        console.log('scanned_barcode ' + scanned_barcode)
    }
    // --Barcode reader

    // Errors
    var estimated_date = "{{estimated_date}}"
    var feedback_status = "{{feedback_status}}"
    var estimated_date_issmall = "{{estimated_date_issmall}}"
    console.log(estimated_date, feedback_status, estimated_date_issmall)
    // if ((!estimated_date && !feedback_status) || (estimated_date && estimated_date_issmall)){
    if ((estimated_date=="None" && feedback_status=="False") || (estimated_date!="None" && estimated_date_issmall=="True")){
        $('#estimated_date').toggleClass('is-invalid')
    }
    var changed_user = "{{changed_user}}"
    console.log(changed_user, feedback_status)
    if (changed_user=="None" && feedback_status=="False"){
        $('#add_user').toggleClass('is-invalid')
    }
    var changed_items = "{{changed_items}}"
    console.log(changed_items, feedback_status)
    if (changed_items=="[]" && feedback_status=="False"){
        $('#add_item').toggleClass('is-invalid')
    }
    // --Errors

});
</script>
{% endblock %}

{% block main_content %}

<div class="new_event_warp">
    <form method="get" action="">
        {% comment %} <input name="barcode" id="barcode" type="hidden" class="aq" />
        <input name="barcode1" id="barcode1" type="hidden" class="aq" /> {% endcomment %}
        <div class="d-flex justify-content-center pt-5" style="">
            <div class="d-flex flex-column align-items-end w-50">
                <div class="row g-3 w-100">

                    <div class="dates_choice col-auto w-100 mb-5">
                        <div class="dates mt-2 ms-1 d-flex">
                            <div>
                                <span class="small">Alkamisaika</span>
                                <input name="rental_start" class="d-flex flex-grow-1 flex-shrink-1 datepicker_input form-control" type="date" value="{{datenow|date:'Y-m-d'}}" style="" disabled />
                                {% comment %} {{datenow|date:'Y-m-d'}} {% endcomment %}
                            </div>
                            <div>
                                <span class="small">Päättymisaika</span>
                                <input id="estimated_date" name="estimated_date" class="d-flex flex-grow-1 flex-shrink-1 datepicker_input form-control" type="date" {% if request.GET.estimated_date %}value="{{request.GET.estimated_date}}"{% endif %}  style="" />
                                <div class="feedback-invalid {% if not estimated_date and not feedback_status %}show{% else %}hide{% endif %}">
                                    Kenttä on pakollinen
                                </div>
                                <div class="feedback-invalid {% if estimated_date and estimated_date_issmall %}show{% else %}hide{% endif %}">
                                    Valittu liian lyhyt ajanjakso
                                </div>
                                {% comment %} {{request.GET.estimated_date}} {% endcomment %}
                            </div>
                        </div>
                    </div>

                    <div class="col-auto w-100">
                        {% comment %} {% csrf_token %} {% endcomment %}
                        <!-- style="border: 1px solid red;" -->
                        <div class="d-flex align-items-end" >
                            <div class="me-3 w-100">
                                <label for="add_user" class="form-label">Skannaa opiskelijakortti tai kirjoittaa opiskelijanumero.</label>
                                {% if not changed_user %}
                                <input name="add_user" type="text" class="form-control" id="add_user" placeholder="kirjoita opiskelijanumero tai nimi">
                                {% else %}
                                <input name="add_user" value="{{changed_user.code}}" type="text" class="form-control" id="add_user" >
                                {% endif %}
                                
                            </div>
                            <div class="">
                                <button name="_add_user" type="submit" class="list__button list__button_bg_green btn_strech" id="_add_user">
                                    <span class="bi bi-plus font-size"></span>
                                </button>
                            </div>
                        </div>
                        <div class="feedback-invalid {% if not changed_user and not feedback_status %}show{% else %}hide{% endif %}">
                            Kenttä on pakollinen
                        </div>
                    </div>
                    
                    <div class="col-auto w-100" style="{% if changed_user %}display: block{%else%}display: none{%endif%};">
                        <div class="d-flex flex-row justify-content-between">
                            <div class="mb-3 me-3">
                                <h4>{{changed_user.first_name}} {{changed_user.last_name}}</h4>
                                <p>{{changed_user.email}}</p>
                            </div>
                            <div class="mb-3 d-flex">
                                <button name="_remove_user" type="submit" class="list__button list__button_bg_red btn_strech">
                                    <span class="bi bi-dash font-size"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mt-3 w-100 mb-4">
                    <div class="col-auto w-100">
                        <div class="d-flex align-items-end">
                            <div class="me-3 w-100">
                                <label for="add_item" class="form-label">skannaa tuote, kirjoita tuotenumero tai lisää napilla.</label>
                                <input name="add_item{{changed_items|length}}" type="text" class="form-control" id="add_item" placeholder="kirjoita tuotenumero">
                            </div>
                            <div class="me-3">
                                <button id="add_product" type="button" class="list__button list__button_bg_green btn_strech btn-small" data-bs-toggle="modal" data-bs-target="#goods" >
                                    <span class="list__button__text">Lisää tuote</span>
                                </button>
                            </div>
                            <div class="">
                                <button type="submit" class="list__button list__button_bg_green btn_strech">
                                    <span class="bi bi-plus font-size"></span>
                                </button>
                            </div>
                        </div>
                        <div class="feedback-invalid {% if not changed_items and not feedback_status %}show{% else %}hide{% endif %}">
                            Kenttä on pakollinen
                        </div>
                    </div>
                </div>
                {% comment %} {{changed_items|length}} {% endcomment %}
                {% for changed_item in changed_items %}
                <div class="col-auto w-100" style="{% if changed_items %}display: block{%else%}display: none{%endif%};">
                    <div class="d-flex flex-row justify-content-between px-2" >
                        <div class="mb-3 me-3">
                            <input name="add_item{{forloop.counter0}}" value="{{changed_item.id}}" type="hidden" class="form-control" id="exampleFormControlInput1" placeholder="kirjoita tuotenumero">
                            <h4>{{changed_item.item_name}} {{changed_item.brand}} {{changed_item.model}}</h4>
                            <p>{{changed_item.item_type}} {{changed_item.parameters}} {{changed_item.size}}</p>
                        </div>
                        <div class="mb-3 d-flex">
                            <button type="submit" name="_remove_item" value="{{forloop.counter0}}" class="list__button list__button_bg_red btn_strech">
                                <span class="bi bi-dash font-size"></span>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </form>
    
    <div class="main_buttons right pb-2 pe-2">
        <div>
            <form action="" method="post">
                <div>
                    {% csrf_token %}
                    {% if estimated_date %}<input name="estimated_date" value="{{request.GET.estimated_date}}" type="hidden" >{% endif %}
                    {% if changed_user %}<input name="add_user" value="{{changed_user}}" type="hidden">{% endif %}
                    {% if changed_items %}
                        {% for changed_item in changed_items %}
                        <input name="add_item{{forloop.counter0}}" value="{{changed_item.id}}" type="hidden">
                        {% endfor %}
                    {% endif %}
                    <button type="button" class="btn btn-primary me-2">
                        <span class="button_s__text">PERUUTA</span>
                    </button> 
                    <button type="submit" class="btn btn-primary">
                        <span class="button_s__text">TALLENNA</span>  
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal 1-->
<div class="modal fade" id="goods" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" id="modal">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Valitse tuotteita</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">

                {% include 'varasto/new_event_goods.html' with items=items %}
                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">SULJE</button>
                <button type="submit" class="btn btn-secondary">TALLENNA</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
// const elem = document.querySelector('input');
// if (elem === document.activeElement) {
//     console.log('Element has focus!');
// } else {
//     console.log(`Element is not focused.`);
// }

</script>
{% endblock %}
